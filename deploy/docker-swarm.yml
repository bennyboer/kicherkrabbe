services:
  traefik:
    image: traefik:v3.6
    command:
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
    ports:
      - target: 80
        published: 80
        mode: host
      - target: 443
        published: 443
        mode: host
    volumes:
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certificates:/letsencrypt
    networks:
      - traefik-public
      - internal
    deploy:
      placement:
        constraints:
          - node.role == manager

  mongo:
    image: mongo:8.2
    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb
    networks:
      - internal
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USERNAME:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
    command: ["mongod", "--port", "27017", "--bind_ip", "0.0.0.0", "--replSet", "rs0", "--auth", "--keyFile", "/run/secrets/mongo-keyfile"]
    secrets:
      - source: mongo-keyfile
        uid: '999'
        gid: '999'
        mode: 0400
    deploy:
      placement:
        constraints:
          - node.role == manager

  mongo-init:
    image: mongo:8.2
    networks:
      - internal
    environment:
      - MONGO_ROOT_USERNAME=${MONGO_ROOT_USERNAME:-admin}
      - MONGO_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
      - MONGO_APP_USERNAME=${MONGO_APP_USERNAME:-kicherkrabbe}
      - MONGO_APP_PASSWORD=${MONGO_APP_PASSWORD}
    entrypoint: >
      bash -c '
        sleep 10
        echo "Initializing replica set..."
        mongosh --host mongo:27017 -u $$MONGO_ROOT_USERNAME -p $$MONGO_ROOT_PASSWORD --authenticationDatabase admin --eval "
          try {
            rs.status()
          } catch (err) {
            rs.initiate({_id: \"rs0\", members: [{_id: 0, host: \"mongo:27017\"}]})
          }
        "
        echo "Creating/updating application user..."
        mongosh --host mongo:27017 -u $$MONGO_ROOT_USERNAME -p $$MONGO_ROOT_PASSWORD --authenticationDatabase admin --eval "
          db = db.getSiblingDB(\"kicherkrabbe\")
          if (db.getUser(\"$$MONGO_APP_USERNAME\") == null) {
            db.createUser({
              user: \"$$MONGO_APP_USERNAME\",
              pwd: \"$$MONGO_APP_PASSWORD\",
              roles: [{role: \"readWrite\", db: \"kicherkrabbe\"}]
            })
          } else {
            db.changeUserPassword(\"$$MONGO_APP_USERNAME\", \"$$MONGO_APP_PASSWORD\")
          }
        "
        echo "MongoDB initialization complete!"
      '
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5

  rabbitmq:
    image: rabbitmq:4.2-management
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - internal
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-kicherkrabbe}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}

  app:
    image: ${APP_IMAGE:-kicherkrabbe-server:latest}
    networks:
      - internal
      - traefik-public
    volumes:
      - ${ASSETS_PATH:-/home/kicherkrabbe/.kicherkrabbe-assets}:/app/.kicherkrabbe-assets
    environment:
      - SPRING_MONGODB_URI=mongodb://${MONGO_APP_USERNAME:-kicherkrabbe}:${MONGO_APP_PASSWORD}@mongo:27017/kicherkrabbe?replicaSet=rs0&authSource=kicherkrabbe
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=${RABBITMQ_USER:-kicherkrabbe}
      - SPRING_RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - KICHERKRABBE_KEY_PAIR=/run/secrets/jwt-keypair
      - ASSETS_STORAGE_FILE_ROOT_LOCATION=/app/.kicherkrabbe-assets
    secrets:
      - jwt-keypair
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.app.rule=Host(`api.${DOMAIN}`)"
        - "traefik.http.routers.app.entrypoints=websecure"
        - "traefik.http.routers.app.tls.certresolver=letsencrypt"
        - "traefik.http.routers.app.middlewares=security-headers@swarm"
        - "traefik.http.services.app.loadbalancer.server.port=8080"
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
    depends_on:
      - mongo
      - rabbitmq

  customer:
    image: ${CUSTOMER_IMAGE:-ghcr.io/bennyboer/kicherkrabbe-customer:latest}
    networks:
      - traefik-public
    environment:
      - PORT=4000
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.customer.rule=Host(`${DOMAIN}`)"
        - "traefik.http.routers.customer.entrypoints=websecure"
        - "traefik.http.routers.customer.tls.certresolver=letsencrypt"
        - "traefik.http.routers.customer.middlewares=security-headers@swarm"
        - "traefik.http.services.customer.loadbalancer.server.port=4000"
        - "traefik.http.routers.customer-www.rule=Host(`www.${DOMAIN}`)"
        - "traefik.http.routers.customer-www.entrypoints=websecure"
        - "traefik.http.routers.customer-www.tls.certresolver=letsencrypt"
        - "traefik.http.routers.customer-www.middlewares=security-headers@swarm,www-redirect"
        - "traefik.http.middlewares.www-redirect.redirectregex.regex=^https://www\\.(.+)"
        - "traefik.http.middlewares.www-redirect.redirectregex.replacement=https://$${1}"
        - "traefik.http.middlewares.www-redirect.redirectregex.permanent=true"
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s

  management:
    image: ${MANAGEMENT_IMAGE:-ghcr.io/bennyboer/kicherkrabbe-management:latest}
    networks:
      - traefik-public
    environment:
      - PORT=4200
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
        - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
        - "traefik.http.middlewares.security-headers.headers.stsPreload=true"
        - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
        - "traefik.http.middlewares.security-headers.headers.frameDeny=true"
        - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
        - "traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
        - "traefik.http.middlewares.security-headers.headers.permissionsPolicy=geolocation=(), microphone=(), camera=()"
        - "traefik.http.routers.management.rule=Host(`manage.${DOMAIN}`)"
        - "traefik.http.routers.management.entrypoints=websecure"
        - "traefik.http.routers.management.tls.certresolver=letsencrypt"
        - "traefik.http.routers.management.middlewares=security-headers@swarm"
        - "traefik.http.services.management.loadbalancer.server.port=4200"
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s

networks:
  traefik-public:
    driver: overlay
    attachable: true
  internal:
    driver: overlay
    internal: true

volumes:
  traefik-certificates:
  mongo-data:
  mongo-config:
  rabbitmq-data:

secrets:
  mongo-keyfile:
    external: true
  jwt-keypair:
    external: true
